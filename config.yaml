# DX Cluster Configuration

server:
  name: "Go Cluster beta 1"
  node_id: "N2WQ-22"

stats:
  display_interval_seconds: 60  # How often to print stats to stdout

# Telnet server (user-facing interface)
telnet:
  port: 8300
  tls_enabled: false
  max_connections: 100
  welcome_message: "\r\nExperimental DX Cluster\r\n"
  login_greeting: "\r\n<CALL> de <CLUSTER>>\r\n"
  duplicate_login_message: "Another login for your callsign connected. This session is being closed (multiple logins are not allowed)."
  broadcast_workers: 0            # 0 means automatic (uses all CPU cores, minimum 2)
  broadcast_queue_size: 20480     # Buffer depth for the global telnet broadcast queue
  worker_queue_size: 512          # Jobs queued per broadcast worker before dropping
  client_buffer_size: 512         # Per-client spot backlog before a slow session drops spots
  skip_handshake: true            # Set true to disable Telnet option negotiation (raw TCP clients)

# Default filters applied to new users
filter:
  default_modes:
    - CW
    - LSB
    - USB
    - RTTY

# Core processing / protections
dedup:
  cluster_window_seconds: 120     # Dedup window in seconds (0 disables dedup without changing the pipeline)
  prefer_stronger_snr: true       # When duplicates collide, keep the strongest SNR version
  output_buffer_size: 40960       # Capacity of the dedup output channel (raise to reduce drops)

# Shared callsign normalization cache (spotters + DX calls)
call_cache:
  size: 4096                      # Max cached entries for normalized calls/spotters
  ttl_seconds: 600                # Expire cached entries after this many seconds (>0)

# Consensus thresholds for automated call corrections (only CW/RTTY/USB/LSB considered)
call_correction:
  enabled: true                   # Master switch (set true to enable)
  strategy: "majority"            # Strategy: majority | center | classic
                                  #   majority: most unique spotters on-frequency wins; distance is a safety cap
                                  #   center:   distance-based cluster center (median-like) then compare to subject
                                  #   classic:  legacy subject-vs-alternate with distance gating
  debug_log: true                 # Emit per-subject correction decisions when true (for tuning/compare)
  debug_log_file: "data/logs/callcorr_debug_modified.log"              # Optional file path to append correction debug lines (uses main log when empty)
  min_consensus_reports: 3        # Minimum number of corroborating spotters
  min_advantage: 1                # Candidate must exceed the original by this many spotters
  min_confidence_percent: 60      # Candidate supporters must represent at least this percent of unique spotters
  recency_seconds: 360            # Supporting spots must be this recent (default for all modes)
  recency_seconds_cw: 0           # Optional override for CW (0 = inherit recency_seconds)
  recency_seconds_rtty: 0         # Optional override for RTTY (0 = inherit recency_seconds)
  max_edit_distance: 3            # Max allowed Levenshtein distance between original and replacement
  frequency_tolerance_hz: 1000    # Spots within this frequency window are considered the same signal
  freq_guard_min_separation_khz: 0.1 # Skip corrections when winner/runner-up are separated by at least this kHz
  freq_guard_runnerup_ratio: 0.5  # Runner-up must have at least this fraction of winner supporters to block correction
  quality_bin_hz: 500             # Frequency bin size for quality anchors (Hz)
  quality_good_threshold: 2       # Q >= this value marks a call as a good anchor in its bin
  quality_newcall_increment: 1    # Increment applied to winner call after resolved cluster
  quality_busted_decrement: 1     # Decrement applied to losing calls in cluster
  distance_model_cw: "morse"      # "plain" = standard Levenshtein, "morse" = Morse-aware (CW only)
  distance_model_rtty: "baudot"   # "plain" = standard Levenshtein, "baudot" = Baudot-aware (RTTY only)
  invalid_action: "broadcast"     # "broadcast" original if correction fails CTY, or "suppress" to drop spot
  min_snr_cw: 4                   # Ignore CW corroborators weaker than this many dB
  min_snr_rtty: 3                 # Ignore RTTY corroborators weaker than this many dB
  distance3_extra_reports: 1      # Extra unique supporters required when suggested call is distance 3
  distance3_extra_advantage: 1    # Extra advantage over the subject required when distance 3
  distance3_extra_confidence: 5   # Extra confidence percentage points required when distance 3
  distance_cache_size: 8192       # Memoize call distance calculations (entries)
  distance_cache_ttl_seconds: 120 # Expire cached distances after this many seconds (tie to recency window)
  morse_weights:
    insert: 1                     # Cost to insert a dot/dash in Morse patterns
    delete: 1                     # Cost to delete a dot/dash in Morse patterns
    sub: 2                        # Cost to flip dot<->dash in Morse patterns
    scale: 2                      # Multiplier for normalized Morse cost before rounding
  baudot_weights:
    insert: 1                     # Cost to insert a bit in ITA2 patterns
    delete: 1                     # Cost to delete a bit in ITA2 patterns
    sub: 2                        # Cost to flip a bit in ITA2 patterns
    scale: 2                      # Multiplier for normalized ITA2 cost before rounding
  adaptive_refresh:
    busy_threshold_per_min: 500   # Enter busy when the 10m average exceeds this rate
    quiet_threshold_per_min: 300  # Exit busy after two windows below this rate
    quiet_consecutive_windows: 2  # Windows below quiet threshold required to leave busy
    busy_interval_minutes: 15     # Refresh cadence during busy periods
    quiet_interval_minutes: 45    # Refresh cadence during quiet periods
    min_spots_since_last_refresh: 1000 # Skip refresh when volume since last run is below this
    window_minutes_for_rate: 10   # Window size for computing average rate
    evaluation_period_seconds: 30 # How often to evaluate the rate/state machine

# Harmonic suppression for CW/USB/LSB/RTTY signals
harmonics:
  enabled: true                   # Suppress harmonics when true
  recency_seconds: 120            # Look-back window for fundamental spots
  max_harmonic_multiple: 3        # Highest harmonic multiple to consider (2 = second harmonic, etc.)
  frequency_tolerance_hz: 500     # Allowed deviation between expected and observed harmonic
  min_report_delta: 6             # Harmonics must be at least this many dB weaker to drop
  min_report_delta_step: 3.5      # Additional dB required per harmonic order above the second

spot_policy:
  max_age_seconds: 300                   # Drop spots older than this many seconds (based on spot timestamp)
  frequency_averaging_seconds: 120       # Look-back window for CW/RTTY frequency averaging
  frequency_averaging_tolerance_hz: 500  # Max deviation between reports when averaging
  frequency_averaging_min_reports: 5     # Minimum corroborating reports needed to adjust frequency

# Spot sources
rbn:
  enabled: true
  name: "RBN-CW-RTTY"
  host: "telnet.reversebeacon.net"
  port: 7000
  callsign: "N0CW"               # Change this to your callsign!
  keep_ssid_suffix: true         # false collapses VE3EID-1/-2 into VE3EID-#

rbn_digital:
  enabled: true
  name: "RBN-FT4-FT8"
  host: "telnet.reversebeacon.net"
  port: 7001
  callsign: "N0FT"              # Change this to your callsign!
  keep_ssid_suffix: true        # false collapses VE3EID-1/-2 into VE3EID-#

pskreporter:
  enabled: false
  name: "PSKReporter"
  broker: "mqtt.pskreporter.info"
  port: 1883
  modes: ["FT8", "FT4", "CW", "RTTY"]  # List of MQTT modes to subscribe to
  workers: 0                           # 0 means automatic (uses all CPU cores, minimum 1)
  append_spotter_ssid: true            # Append "-#" to receiver calls lacking an SSID for dedup

# Reference data and persistence
cty:
  file: "data/cty/cty.plist"           # Path to the CTY prefix database (cty.plist)

known_calls:
  enabled: true
  url: "https://www.supercheckpartial.com/MASTER.SCP"
  file: "data/scp/MASTER.SCP"
  refresh_utc: "00:01"                    # Daily download time in HH:MM UTC

fcc_uls:
  enabled: true
  url: "https://data.fcc.gov/download/pub/uls/complete/l_amat.zip"  # FCC ULS amateur archive
  archive_path: "data/fcc/l_amat.zip"                               # Where to store the downloaded ZIP
  db_path: "data/fcc/fcc_uls.db"                                    # Where to write the built SQLite database
  temp_dir: "data/fcc"                                              # SQLite temp/sort files for FCC build
  refresh_utc: "22:00"                                              # Daily download time in HH:MM UTC

# Combined database for known calls + grids
grid_db: "data/grids/calls.db"
grid_flush_seconds: 60                 # Batch DB writes at most once per this many seconds
grid_cache_size: 3000                  # Max in-memory grid cache entries (lazy LRU; falls back to SQLite on miss)
grid_cache_ttl_seconds: 3600           # >0 expires cache entries after this many seconds (0=never expires)
grid_ttl_days: 90                      # >0 prunes grid records older than this many days (0=keep forever)

# RBN skew correction table
skew:
  enabled: true
  url: "https://sm7iun.se/rbnskew.csv"
  file: "data/skm_correction/rbnskew.json"
  min_spots: 500                       # Require this many spots before trusting a skimmer's correction
  refresh_utc: "00:30"                 # Daily download time in HH:MM UTC

buffer:
  capacity: 250000                     # Number of spots held in the in-memory ring buffer
