# DX Cluster Configuration (legacy single-file form).
# Default runtime loads data/config/*.yaml; set DXC_CONFIG_PATH=config.yaml to use this file instead.

server:
  name: "Go Cluster beta\r\n"
  node_id: "N2WQ-2"

stats:
  display_interval_seconds: 60  # How often to print stats to stdout

# Local console UI (applies only to the process console, not telnet clients)
ui:
  mode: "tview"     # ansi | tview | headless
  refresh_ms: 250     # ANSI redraw cadence; 0 disables redraws
  color: true         # Enable simple ANSI colors for marked-up lines
  clear_screen: true  # Clear the screen each frame (set false to append)
  pane_lines:
    stats: 10         # Lines retained in the stats block
    calls: 9          # Corrected calls history
    unlicensed: 9     # Unlicensed drops history
    harmonics: 9      # Harmonic drops history
    system: 9         # System log history

# Spot sources (ingest)
rbn:
  enabled: true
  name: "RBN-CW-RTTY"
  host: "telnet.reversebeacon.net"
  port: 7000
  callsign: "N2WQ-2"               # Change this to your callsign!
  slot_buffer: 1000              # Buffer depth between telnet reader and pipeline (per-spot queue)
  keep_ssid_suffix: false        # Broadcast: true preserves SSIDs; false collapses to base-# for display

rbn_digital:
  enabled: true
  name: "RBN-FT4-FT8"
  host: "telnet.reversebeacon.net"
  port: 7001
  callsign: "N2WQ-2"              # Change this to your callsign!
  slot_buffer: 1000             # Buffer depth between telnet reader and pipeline (FT4/FT8 bursts are spiky)
  keep_ssid_suffix: true        # Broadcast: true preserves SSIDs; false collapses to base-#

# Optional human/relay telnet ingest (POC or upstream cluster)
human_telnet:
  enabled: true
  name: "HUMAN-SPOTS"
  host: "dxs.n2wq.com"
  port: 7300
  callsign: "N2WQ-22"          # Change this to your callsign or upstream ID
  slot_buffer: 1000            # Buffer depth between telnet reader and pipeline
  keep_ssid_suffix: true       # Set false to collapse SSIDs when broadcasting

pskreporter:
  enabled: true
  name: "PSKReporter"
  broker: "mqtt.pskreporter.info"
  port: 1883
  modes: ["FT8", "FT4", "CW", "RTTY", "MSK144"]  # List of MQTT modes to subscribe to
  workers: 0                           # 0 means automatic (uses all CPU cores, minimum 4)
  append_spotter_ssid: true            # Append "-#" to receiver calls lacking an SSID for dedup

# Normalization/cache (shared across sources)
call_cache:
  size: 4096                      # Max cached entries for normalized calls/spotters
  ttl_seconds: 600                # Expire cached entries after this many seconds (>0)

# Core protections (primary pipeline)
dedup:
  cluster_window_seconds: 120     # Primary dedup window (all sources before ring)
  secondary_window_seconds: 60    # Secondary dedup window (broadcast-only, by DE DXCC+zone)
  prefer_stronger_snr: true       # Primary: keep strongest SNR on duplicate collisions
  secondary_prefer_stronger_snr: false # Secondary: keep strongest SNR within country+zone bucket
  output_buffer_size: 16384       # Capacity of dedup output channel (raise to reduce drops)

# Consensus-based call correction (CW/RTTY/SSB; FT8/FT4 are skipped)
call_correction:
  enabled: true                   # Master switch (set true to enable)
  strategy: "majority"            # Strategy: majority | center | classic
                                  #   majority: most unique spotters on-frequency wins; distance is a safety cap
                                  #   center:   distance-based cluster center (median-like) then compare to subject
                                  #   classic:  legacy subject-vs-alternate with distance gating
  debug_log: true                 # Enable SQLite decision logging for call correction (non-blocking writer)
  debug_log_file: "data/logs/callcorr_debug.log"              # Optional path/prefix for the daily decision DB (defaults to data/analysis/callcorr_YYYY-MM-DD.db)
  min_consensus_reports: 2        # Minimum number of corroborating spotters
  min_advantage: 1                # Candidate must exceed the original by this many spotters
  min_confidence_percent: 55      # Candidate supporters must represent at least this percent of unique spotters
  recency_seconds: 360            # Supporting spots must be this recent (default for all modes)
  recency_seconds_cw: 0           # Optional override for CW (0 = inherit recency_seconds)
  recency_seconds_rtty: 0         # Optional override for RTTY (0 = inherit recency_seconds)
  max_edit_distance: 3            # Max allowed Levenshtein distance between original and replacement
  frequency_tolerance_hz: 1000    # Spots within this frequency window are considered the same signal
  freq_guard_min_separation_khz: 0.1 # Skip corrections when winner/runner-up are separated by at least this kHz
  freq_guard_runnerup_ratio: 0.5  # Runner-up must have at least this fraction of winner supporters to block correction
  quality_bin_hz: 500             # Frequency bin size for quality anchors (Hz); kept as a global fallback
  quality_good_threshold: 2       # Q >= this value marks a call as a good anchor in its bin
  quality_newcall_increment: 1    # Increment applied to winner call after resolved cluster
  quality_busted_decrement: 1     # Decrement applied to losing calls in cluster
  distance_model_cw: "morse"      # "plain" = standard Levenshtein, "morse" = Morse-aware (CW only)
  distance_model_rtty: "baudot"   # "plain" = standard Levenshtein, "baudot" = Baudot-aware (RTTY only)
  invalid_action: "broadcast"     # "broadcast" original if correction fails CTY, or "suppress" to drop spot
  min_snr_cw: 4                   # Ignore CW corroborators weaker than this many dB
  min_snr_rtty: 3                 # Ignore RTTY corroborators weaker than this many dB
  distance3_extra_reports: 0      # Extra unique supporters required when suggested call is distance 3
  distance3_extra_advantage: 0    # Extra advantage over the subject required when distance 3
  distance3_extra_confidence: 5   # Extra confidence percentage points required when distance 3
  distance_cache_size: 256        # Memoize call distance calculations (entries)
  distance_cache_ttl_seconds: 120 # Expire cached distances after this many seconds (tie to recency window)
  morse_weights:
    insert: 1                     # Cost to insert a dot/dash in Morse patterns
    delete: 1                     # Cost to delete a dot/dash in Morse patterns
    sub: 2                        # Cost to flip dot<->dash in Morse patterns
    scale: 2                      # Multiplier for normalized Morse cost before rounding
  baudot_weights:
    insert: 1                     # Cost to insert a bit in ITA2 patterns
    delete: 1                     # Cost to delete a bit in ITA2 patterns
    sub: 2                        # Cost to flip a bit in ITA2 patterns
    scale: 2                      # Multiplier for normalized ITA2 cost before rounding
  quality_priors_file: "data/quality/quality_priors.dat"         # Optional path to seed call quality priors (CALL SCORE [FREQ_KHZ])
  spotter_reliability_file: "data/quality/spotter_reliability.dat"    # Optional path with spotter weights (SPOTTER WEIGHT 0-1)
  min_spotter_reliability: 0.0    # Ignore reporters below this reliability weight
  # Band/state-aware frequency handling (keeps global defaults as a guardrail for unknown bands)
  band_state_overrides:
    - name: lowbands
      bands: ["160m", "80m"]
      quiet:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
      normal:
        quality_bin_hz: 400
        frequency_tolerance_hz: 900
      busy:
        quality_bin_hz: 300
        frequency_tolerance_hz: 800
    - name: midbands
      bands: ["40m", "20m"]
      quiet:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
      normal:
        quality_bin_hz: 500
        frequency_tolerance_hz: 900
      busy:
        quality_bin_hz: 400
        frequency_tolerance_hz: 800
    - name: highbands
      bands: ["15m", "10m"]
      quiet:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
      normal:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
      busy:
        quality_bin_hz: 500
        frequency_tolerance_hz: 900
    - name: others
      bands: ["30m", "17m", "12m", "60m", "6m"]
      quiet:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
      normal:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
      busy:
        quality_bin_hz: 500
        frequency_tolerance_hz: 1000
  adaptive_refresh:
    busy_threshold_per_min: 500   # Enter busy when the 10m average exceeds this rate
    quiet_threshold_per_min: 300  # Exit busy after two windows below this rate
    quiet_consecutive_windows: 2  # Windows below quiet threshold required to leave busy
    busy_interval_minutes: 15     # Refresh cadence during busy periods
    quiet_interval_minutes: 45    # Refresh cadence during quiet periods
    min_spots_since_last_refresh: 1000 # Skip refresh when volume since last run is below this
    window_minutes_for_rate: 10   # Window size for computing average rate
    evaluation_period_seconds: 30 # How often to evaluate the rate/state machine
  adaptive_refresh_by_band:
    enabled: true
    quiet_refresh_minutes: 30
    normal_refresh_minutes: 20
    busy_refresh_minutes: 10
    min_spots_since_last_refresh: 500
  adaptive_min_reports:
    enabled: true
    window_minutes: 10
    evaluation_period_seconds: 60
    hysteresis_windows: 2
    groups:
      - name: lowbands
        bands: ["160m", "80m"]
        quiet_below: 30
        busy_above: 75
        quiet_min_reports: 2
        normal_min_reports: 3
        busy_min_reports: 3
      - name: midbands
        bands: ["40m", "20m"]
        quiet_below: 80
        busy_above: 130
        quiet_min_reports: 2
        normal_min_reports: 3
        busy_min_reports: 3
      - name: highbands
        bands: ["15m", "10m"]
        quiet_below: 35
        busy_above: 85
        quiet_min_reports: 2
        normal_min_reports: 3
        busy_min_reports: 3
      - name: others
        bands: ["30m", "17m", "12m", "60m", "6m"]
        quiet_below: 20
        busy_above: 55
        quiet_min_reports: 2
        normal_min_reports: 3
        busy_min_reports: 3

# Harmonic suppression (CW/USB/LSB/RTTY)
harmonics:
  enabled: true                   # Suppress harmonics when true
  recency_seconds: 120            # Look-back window for fundamental spots
  max_harmonic_multiple: 3        # Highest harmonic multiple to consider (2 = second harmonic, etc.)
  frequency_tolerance_hz: 500     # Allowed deviation between expected and observed harmonic
  min_report_delta: 6             # Harmonics must be at least this many dB weaker to drop
  min_report_delta_step: 3.5      # Additional dB required per harmonic order above the second

# Generic spot policy (post-protections)
spot_policy:
  max_age_seconds: 300                   # Drop spots older than this many seconds (based on spot timestamp)
  frequency_averaging_seconds: 120       # Look-back window for CW/RTTY frequency averaging
  frequency_averaging_tolerance_hz: 500  # Max deviation between reports when averaging
  frequency_averaging_min_reports: 5     # Minimum corroborating reports needed to adjust frequency

# Reference data (CTY/known/FCC/skew)
cty:
  enabled: true
  url: "https://www.country-files.com/cty/cty.plist"
  file: "data/cty/cty.plist"           # Path to the CTY prefix database (cty.plist)
  refresh_utc: "00:10"                 # Daily download time in HH:MM UTC

known_calls:
  enabled: true
  url: "https://www.supercheckpartial.com/MASTER.SCP"
  file: "data/scp/MASTER.SCP"
  refresh_utc: "00:20"                    # Daily download time in HH:MM UTC

fcc_uls:
  enabled: true
  url: "https://data.fcc.gov/download/pub/uls/complete/l_amat.zip"  # FCC ULS amateur archive
  archive_path: "data/fcc/l_amat.zip"                               # Where to store the downloaded ZIP
  db_path: "data/fcc/fcc_uls.db"                                    # Where to write the built SQLite database
  temp_dir: "data/fcc"                                              # SQLite temp/sort files for FCC build
  refresh_utc: "22:00"                                              # Daily download time in HH:MM UTC

# Combined database for known calls + grids
 grid_db: "data/grids/pebble"
 grid_flush_seconds: 60                 # Batch DB writes at most once per this many seconds
 grid_cache_size: 10240                 # Max in-memory grid cache entries (lazy LRU; falls back to Pebble on miss)
 grid_cache_ttl_seconds: 3600           # >0 expires cache entries after this many seconds (0=never expires)
 grid_db_check_on_miss: true            # When true, consult Pebble on cache miss to avoid redundant writes (A/B via DXC_GRID_DB_CHECK_ON_MISS)
 grid_ttl_days: 90                      # >0 prunes grid records older than this many days (0=keep forever)
 grid_block_cache_mb: 64                # Block cache shared across SSTables for repeated grid lookups
 grid_bloom_filter_bits: 10             # Bloom filter bits/key for faster negative lookups
 grid_memtable_size_mb: 32              # Write buffer size to absorb bursts before flushing SSTables
 grid_l0_compaction_threshold: 4        # Files in L0 before triggering compaction
 grid_l0_stop_writes_threshold: 16      # Stop writes when L0 reaches this many files (burst tolerance)
 grid_write_queue_depth: 64             # Buffered channel feeding the single writer (higher for bursty ingest)

# RBN skew correction table
skew:
  enabled: true
  url: "https://sm7iun.se/rbnskew.csv"
  file: "data/skm_correction/rbnskew.json"
  min_spots: 500                       # Require this many spots before trusting a skimmer's correction
  refresh_utc: "00:30"                 # Daily download time in HH:MM UTC

# Persistence
buffer:
  capacity: 50000                      # Number of spots held in the in-memory ring buffer (post-primary dedup)

# Telnet server (user-facing interface)
telnet:
  port: 9300
  tls_enabled: false
  max_connections: 100
  welcome_message: "\r\nExperimental DX Cluster\r\n"
  login_greeting: "\r\n<CALL> de <CLUSTER> <DATETIME>>\r\n"
  duplicate_login_message: "Another login for your callsign connected. This session is being closed (multiple logins are not allowed)."
  broadcast_workers: 0            # 0 means automatic (uses all CPU cores, minimum 4)
  broadcast_queue_size: 8192      # Buffer depth for the global telnet broadcast queue
  broadcast_batch_interval_ms: 250 # Micro-batching interval for telnet broadcasts (0 = immediate)
  worker_queue_size: 512          # Jobs queued per broadcast worker before dropping
  client_buffer_size: 512         # Per-client spot backlog before a slow session drops spots
  skip_handshake: true            # Set true to disable Telnet option negotiation (raw TCP clients)
  login_line_limit: 32            # Max bytes accepted for the initial login prompt (DoS guardrail)
  command_line_limit: 128         # Max bytes accepted for post-login commands (filters, etc.)

# Default filters applied to new users
filter:
  default_modes:
    - CW
    - LSB
    - USB
    - RTTY
    - MSK144
  default_sources:
    - HUMAN
